# Telegram 消息转发管理工具 🚀

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Version](https://img.shields.io/badge/version-2.0.0-brightgreen.svg)
![Platform](https://img.shields.io/badge/platform-Linux-green.svg)

这是一个用于管理 Telegram 消息转发的工具，支持多账号私聊消息实时转发到指定群组。通过交互式菜单，你可以轻松安装依赖、配置脚本、启动/停止脚本、查看日志等。

## ✨ 功能特性

- **模块化架构**：采用模块化设计，代码更清晰，维护更简单。
- **按需加载**：只下载和加载需要的功能模块，提高启动速度和资源利用率。
- **多系统支持**：兼容 Alpine、Ubuntu/Debian、CentOS/RHEL/Fedora 等多种 Linux 发行版。
- **依赖安装**：自动安装 Python 和 Telethon，自动检测系统类型。
- **脚本配置**：生成 Telegram 消息转发脚本，支持多账号。
- **进程管理**：内置监控进程，支持自动重启。
- **日志管理**：通过 `logrotate` 自动轮转日志，节省空间。
- **配置备份**：支持配置和会话文件的备份与恢复。
- **快捷命令**：安装后可使用 `tg` 命令快速启动脚本。
- **智能引导**：自动检测配置状态，引导用户完成必要步骤。
- **账户监控**：自动检测小号状态，提示需要重新授权的账户。
- **交互式菜单**：一键操作，简单易用。
- **API凭证加密**：支持API凭证的加密存储，提高安全性。
- **消息过滤**：支持白名单和黑名单过滤，精确控制转发内容。

## 📋 前提条件

确保你的服务器满足以下条件：

- **操作系统**：支持 Alpine、Ubuntu/Debian、CentOS/RHEL/Fedora 等主流 Linux 发行版。
- **工具**：已安装 `curl` 和 `bash`。
- **网络**：可以访问 Telegram API 和 GitHub。
- **权限**：需要有安装软件包的权限（通常需要 sudo 或 root）。

## 🚀 快速开始

### 1. 下载并运行脚本

> ```bash
> curl -fsSL https://raw.githubusercontent.com/mqiancheng/telegram-forward/main/telegram_forward_v3.sh -o telegram_forward_v3.sh && chmod +x telegram_forward_v3.sh && ./telegram_forward_v3.sh
> ```

### 2. 使用交互式菜单

运行脚本后，你会看到以下菜单：

```plaintext
=== Telegram 消息转发管理工具 ===
版本: 2.0.0
--- 当前状态 ---
脚本未运行
虚拟环境已创建
脚本已配置（forward.py 存在）
小号状态：正常（2 个小号）
----------------
1. 安装依赖
2. 配置管理
3. 小号状态
4. 启动脚本
5. 停止脚本
6. 重启脚本
7. 日志管理
8. 备份管理
9. 系统信息
10. 卸载脚本
0. 退出
请选择一个选项：
```

#### 菜单选项说明

| 选项                | 功能描述                                   |
|---------------------|--------------------------------------------|
| **1. 安装依赖**     | 安装 Python、Telethon 和日志管理工具，并创建 `tg` 快捷命令。 |
| **2. 配置管理**     | 进入配置管理子菜单，可以新建、修改、备份和恢复配置。 |
| **3. 小号状态**     | 进入小号状态管理菜单，查看所有小号状态并重新授权失效的小号。 |
| **4. 启动脚本**     | 启动消息转发，首次运行需登录小号。如果配置文件不存在，会自动进入配置管理菜单。 |
| **5. 停止脚本**     | 停止消息转发脚本。                         |
| **6. 重启脚本**     | 重启消息转发脚本。如果配置文件不存在，会自动进入配置管理菜单。 |
| **7. 日志管理**     | 进入日志管理子菜单，可以查看、配置和清理日志。 |
| **8. 备份管理**     | 进入备份管理子菜单，可以创建、恢复和管理备份。 |
| **9. 系统信息**     | 显示系统信息和网络连接状态。               |
| **10. 卸载脚本**    | 卸载脚本及相关文件，但保留备份文件。       |
| **0. 退出**         | 退出程序。                                 |

#### 配置管理子菜单

选择主菜单中的"2. 配置管理"后，会进入以下子菜单：

```plaintext
=== 配置管理菜单 ===
1. 新建配置
2. 修改配置
3. 备份配置
4. 恢复配置
5. 管理备份
0. 返回主菜单
请选择一个选项：
```

#### 小号状态子菜单

选择主菜单中的"3. 小号状态"后，会进入以下子菜单：

```plaintext
=== 小号状态菜单 ===
1. 查看小号状态
2. 重新授权小号
3. 添加新小号
4. 删除小号
0. 返回主菜单
请选择一个选项：
```

#### 日志管理子菜单

选择主菜单中的"7. 日志管理"后，会进入以下子菜单：

```plaintext
=== 日志管理菜单 ===
1. 查看日志
2. 配置日志轮转
3. 清理日志
0. 返回主菜单
请选择一个选项：
```

#### 备份管理子菜单

选择主菜单中的"8. 备份管理"后，会进入以下子菜单：

```plaintext
=== 备份管理菜单 ===
1. 创建备份
2. 恢复备份
3. 管理备份
0. 返回主菜单
请选择一个选项：
```

## 🔑 获取 API 和 Chat ID

### 获取 `api_id` 和 `api_hash`

1. 访问 [my.telegram.org](https://my.telegram.org)，用小号登录。
2. 点击 **API development tools**，创建应用：
   - **App title**：`MyForwardApp`
   - **Short name**：`forward`
   - **Platform**：`Other`
   - **Description**：留空
3. 提交后，记录 `api_id`（例如 `25018336`）和 `api_hash`（例如 `f3dba3011e3b2f9a59e0bbeff20d5db9`）。

### 获取群组 Chat ID

1. 用大号创建私有群组，邀请小号加入。
2. 在 Telegram 中搜索 `@username_to_id_bot`，发送 `/start`。
3. 发送群组邀请链接（例如 `t.me/+xxxxx`）。
4. 记录返回的 Chat ID（例如 `-4688142035`）。

## ⚙️ 脚本工作原理

1. **模块化架构**：脚本采用模块化设计，将不同功能分离到独立模块中。
2. **按需加载**：只有在需要时才会下载和加载相应的功能模块。
3. **监听消息**：脚本登录小号，监听私聊消息。
4. **消息转发**：将消息实时转发到指定群组。
5. **自动重启**：内置监控进程每30秒检查一次主脚本状态，确保脚本持续运行。
6. **配置持久化**：用户设置会保存到配置文件，重启后自动加载。
7. **多系统适配**：自动检测系统类型，使用对应的包管理器和配置路径。
8. **智能引导**：自动检测配置状态，引导用户完成必要步骤。

## 📜 日志管理

- 日志文件：位于用户主目录下的 `forward.log`
- 自动轮转：每天轮转，保留最近 7 天日志，旧日志会被压缩。
- 查看方式：通过菜单选项 7 可以方便地查看日志。

## 💾 备份与恢复

脚本提供了配置备份和恢复功能，可以备份以下内容：

- forward.py 脚本文件
- Telegram 会话文件（session_account*.session）
- 用户配置文件

备份文件保存在 `/home/backup-TGfw` 目录中，格式为 `forward_backup_YYYYMMDD_HHMMSS.tar.gz`。

## ⚠️ 注意事项

- **首次运行**：需输入小号的手机号和验证码登录。
- **安全性**：保护好会话文件（`session_*.session`），避免泄露。
- **权限**：确保小号有权限向目标群组发送消息。
- **日志隐私**：脚本不记录消息内容，仅记录转发事件。
- **系统兼容性**：脚本会自动检测系统类型，但在某些特殊环境可能需要手动调整。
- **账户授权**：如果在 Telegram 端删除了设备授权，小号会显示为异常状态，需要通过"小号状态"菜单重新授权。
- **状态检查**：脚本会在启动时自动检查小号状态，并在状态栏显示结果。

## 🛠️ 故障排除

- **转发失败**：
  1. 使用菜单选项 7 查看日志。
  2. 使用菜单选项 3 检查小号状态，确认是否需要重新授权。
  3. 确认小号是否在群组中，且有发送消息权限。
  4. 确保 `allowed_senders` 配置正确（留空则转发所有私聊消息）。

- **脚本未运行**：
  1. 使用菜单选项 3 检查小号状态。
  2. 使用菜单选项 6 重启脚本。
  3. 检查日志查找错误信息。

- **小号授权失效**：
  1. 使用菜单选项 3 进入小号状态菜单。
  2. 查看标红的小号，这些小号需要重新授权。
  3. 输入需要重新授权的小号序号，按照提示完成重新授权。

- **依赖安装失败**：
  1. 确保系统有足够的权限安装软件包。
  2. 检查网络连接是否正常。
  3. 对于不支持的系统，可能需要手动安装依赖。

- **配置恢复失败**：
  1. 确保备份文件完整且未损坏。
  2. 尝试手动解压备份文件并复制到正确位置。

## 📦 上传到 GitHub

1. 创建 GitHub 仓库（例如 `telegram-forward`）。
2. 提交文件：
   ```bash
   git init
   git add telegram_forward_v3.sh modules/ README.md LICENSE
   git commit -m "Version 2.0.0 release"
   git remote add origin https://github.com/mqiancheng/telegram-forward.git
   git push -u origin main
   ```

## 🔄 更新日志

### 版本 2.0.0
- **全新模块化架构**：将功能分离到独立模块，提高代码可维护性和可扩展性
- **按需加载机制**：只下载和加载需要的功能模块，减少资源占用和启动时间
- **增强的菜单系统**：添加日志管理、备份管理和系统信息等新菜单
- **API凭证加密**：支持API凭证的加密存储，提高安全性
- **改进的日志管理**：添加日志清理功能，更好的日志轮转配置
- **优化的备份系统**：独立的备份管理模块，更灵活的备份和恢复选项
- **增强的错误处理**：更全面的错误检测和恢复机制
- **改进的用户体验**：更清晰的状态显示和操作引导
- **更高的稳定性**：修复了多个潜在的错误和稳定性问题

与1.0版本相比的主要优势：
- **更快的启动速度**：按需加载机制减少了初始下载量和启动时间
- **更低的资源占用**：只加载需要的功能模块，减少内存和CPU使用
- **更好的可维护性**：模块化架构使代码更清晰，更易于维护和扩展
- **更高的安全性**：API凭证加密存储，保护敏感信息
- **更丰富的功能**：添加了更多实用功能，如日志管理、系统信息等
- **更好的用户体验**：更清晰的菜单结构和状态显示，操作更直观

## 🤝 贡献

欢迎提交 Issue 或 Pull Request，优化脚本功能！如果你有任何建议或发现了 bug，请在 GitHub 上提交 Issue。

## 📄 许可证

MIT License